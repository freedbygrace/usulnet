// SPDX-License-Identifier: AGPL-3.0-or-later
// Copyright (c) 2024-2026 usulnet contributors
// https://github.com/fr4nsys/usulnet

// Package protocol defines event types for Gateway-Agent communication.
package protocol

import (
	"context"
	"time"

	"github.com/google/uuid"
)

// EventType identifies the type of event from an agent.
type EventType string

// Docker events (from Docker daemon)
const (
	EventContainerCreate  EventType = "container.create"
	EventContainerStart   EventType = "container.start"
	EventContainerStop    EventType = "container.stop"
	EventContainerDie     EventType = "container.die"
	EventContainerKill    EventType = "container.kill"
	EventContainerPause   EventType = "container.pause"
	EventContainerUnpause EventType = "container.unpause"
	EventContainerDestroy EventType = "container.destroy"
	EventContainerRename  EventType = "container.rename"
	EventContainerRestart EventType = "container.restart"
	EventContainerOOM     EventType = "container.oom"
	EventContainerHealth  EventType = "container.health"
	EventContainerExec    EventType = "container.exec"
)

// Image events
const (
	EventImagePull   EventType = "image.pull"
	EventImagePush   EventType = "image.push"
	EventImageTag    EventType = "image.tag"
	EventImageUntag  EventType = "image.untag"
	EventImageDelete EventType = "image.delete"
	EventImageImport EventType = "image.import"
	EventImageLoad   EventType = "image.load"
	EventImageSave   EventType = "image.save"
)

// Volume events
const (
	EventVolumeCreate  EventType = "volume.create"
	EventVolumeDestroy EventType = "volume.destroy"
	EventVolumeMount   EventType = "volume.mount"
	EventVolumeUnmount EventType = "volume.unmount"
)

// Network events
const (
	EventNetworkCreate     EventType = "network.create"
	EventNetworkDestroy    EventType = "network.destroy"
	EventNetworkConnect    EventType = "network.connect"
	EventNetworkDisconnect EventType = "network.disconnect"
)

// Agent events (generated by agent)
const (
	EventAgentStarted     EventType = "agent.started"
	EventAgentStopping    EventType = "agent.stopping"
	EventAgentReconnected EventType = "agent.reconnected"
	EventAgentError       EventType = "agent.error"
	EventAgentConfigured  EventType = "agent.configured"
)

// Job events
const (
	EventJobStarted   EventType = "job.started"
	EventJobCompleted EventType = "job.completed"
	EventJobFailed    EventType = "job.failed"
	EventJobProgress  EventType = "job.progress"
)

// Security events
const (
	EventSecurityScanStarted   EventType = "security.scan_started"
	EventSecurityScanCompleted EventType = "security.scan_completed"
	EventSecurityVulnFound     EventType = "security.vulnerability_found"
	EventSecurityScoreChanged  EventType = "security.score_changed"
)

// Backup events
const (
	EventBackupStarted   EventType = "backup.started"
	EventBackupCompleted EventType = "backup.completed"
	EventBackupFailed    EventType = "backup.failed"
	EventBackupProgress  EventType = "backup.progress"
	EventRestoreStarted  EventType = "restore.started"
	EventRestoreCompleted EventType = "restore.completed"
	EventRestoreFailed   EventType = "restore.failed"
)

// Update events
const (
	EventUpdateAvailable EventType = "update.available"
	EventUpdateStarted   EventType = "update.started"
	EventUpdateCompleted EventType = "update.completed"
	EventUpdateFailed    EventType = "update.failed"
	EventUpdateRollback  EventType = "update.rollback"
)

// Resource events
const (
	EventResourceLow      EventType = "resource.low"
	EventResourceCritical EventType = "resource.critical"
	EventResourceRecovered EventType = "resource.recovered"
)

// EventSeverity indicates the severity level of an event.
type EventSeverity string

const (
	SeverityDebug    EventSeverity = "debug"
	SeverityInfo     EventSeverity = "info"
	SeverityWarning  EventSeverity = "warning"
	SeverityError    EventSeverity = "error"
	SeverityCritical EventSeverity = "critical"
)

// Event represents an event from an agent.
type Event struct {
	ID          string            `json:"id"`
	Type        EventType         `json:"type"`
	AgentID     string            `json:"agent_id"`
	HostID      string            `json:"host_id"`
	Timestamp   time.Time         `json:"timestamp"`
	Severity    EventSeverity     `json:"severity"`
	Message     string            `json:"message,omitempty"`
	Actor       *EventActor       `json:"actor,omitempty"`
	Attributes  map[string]string `json:"attributes,omitempty"`
	Data        interface{}       `json:"data,omitempty"`
}

// EventActor represents the entity that generated the event.
type EventActor struct {
	Type       string            `json:"type"` // container, image, volume, network, agent
	ID         string            `json:"id"`
	Name       string            `json:"name,omitempty"`
	Attributes map[string]string `json:"attributes,omitempty"`
}

// EventAck is sent by gateway to acknowledge event receipt.
type EventAck struct {
	EventID      string `json:"event_id"`
	Acknowledged bool   `json:"acknowledged"`
	Error        string `json:"error,omitempty"`
}

// Container event data types
type ContainerEventData struct {
	ContainerID   string `json:"container_id"`
	ContainerName string `json:"container_name"`
	Image         string `json:"image"`
	Status        string `json:"status,omitempty"`
	ExitCode      int    `json:"exit_code,omitempty"`
	OOMKilled     bool   `json:"oom_killed,omitempty"`
	HealthStatus  string `json:"health_status,omitempty"`
}

// Image event data
type ImageEventData struct {
	ImageID   string `json:"image_id"`
	ImageName string `json:"image_name"`
	Tag       string `json:"tag,omitempty"`
	Size      int64  `json:"size,omitempty"`
}

// Volume event data
type VolumeEventData struct {
	VolumeName  string `json:"volume_name"`
	Driver      string `json:"driver,omitempty"`
	Destination string `json:"destination,omitempty"`
}

// Network event data
type NetworkEventData struct {
	NetworkID   string `json:"network_id"`
	NetworkName string `json:"network_name"`
	Driver      string `json:"driver,omitempty"`
	ContainerID string `json:"container_id,omitempty"`
}

// Job event data
type JobEventData struct {
	JobID       string   `json:"job_id"`
	JobType     string   `json:"job_type"`
	Progress    int      `json:"progress,omitempty"` // 0-100
	CurrentStep string   `json:"current_step,omitempty"`
	TotalSteps  int      `json:"total_steps,omitempty"`
	Error       string   `json:"error,omitempty"`
	Result      interface{} `json:"result,omitempty"`
}

// Security event data
type SecurityEventData struct {
	ContainerID    string `json:"container_id,omitempty"`
	ContainerName  string `json:"container_name,omitempty"`
	ImageID        string `json:"image_id,omitempty"`
	OldScore       int    `json:"old_score,omitempty"`
	NewScore       int    `json:"new_score,omitempty"`
	VulnID         string `json:"vuln_id,omitempty"`
	VulnSeverity   string `json:"vuln_severity,omitempty"`
	VulnPackage    string `json:"vuln_package,omitempty"`
	TotalVulns     int    `json:"total_vulns,omitempty"`
	CriticalVulns  int    `json:"critical_vulns,omitempty"`
	HighVulns      int    `json:"high_vulns,omitempty"`
}

// Backup event data
type BackupEventData struct {
	BackupID      string `json:"backup_id"`
	ContainerID   string `json:"container_id,omitempty"`
	ContainerName string `json:"container_name,omitempty"`
	VolumeName    string `json:"volume_name,omitempty"`
	SizeBytes     int64  `json:"size_bytes,omitempty"`
	Path          string `json:"path,omitempty"`
	Progress      int    `json:"progress,omitempty"` // 0-100
	Error         string `json:"error,omitempty"`
}

// Update event data
type UpdateEventData struct {
	ContainerID   string `json:"container_id,omitempty"`
	ContainerName string `json:"container_name,omitempty"`
	OldImage      string `json:"old_image,omitempty"`
	NewImage      string `json:"new_image,omitempty"`
	OldVersion    string `json:"old_version,omitempty"`
	NewVersion    string `json:"new_version,omitempty"`
	BackupID      string `json:"backup_id,omitempty"`
	Error         string `json:"error,omitempty"`
}

// Resource event data
type ResourceEventData struct {
	ResourceType  string  `json:"resource_type"` // cpu, memory, disk
	CurrentValue  float64 `json:"current_value"`
	ThresholdValue float64 `json:"threshold_value"`
	Unit          string  `json:"unit"`
	Message       string  `json:"message,omitempty"`
}

// GetSeverity returns the default severity for an event type.
func GetSeverity(eventType EventType) EventSeverity {
	switch eventType {
	case EventContainerDie, EventContainerKill, EventContainerOOM,
		EventAgentError, EventJobFailed, EventBackupFailed, EventRestoreFailed,
		EventUpdateFailed, EventResourceCritical:
		return SeverityError

	case EventContainerHealth, EventSecurityVulnFound, EventResourceLow:
		return SeverityWarning

	case EventContainerCreate, EventContainerStart, EventContainerStop,
		EventContainerPause, EventContainerUnpause, EventContainerDestroy,
		EventContainerRestart, EventContainerRename,
		EventImagePull, EventImagePush, EventImageTag, EventImageDelete,
		EventVolumeCreate, EventVolumeDestroy,
		EventNetworkCreate, EventNetworkDestroy, EventNetworkConnect, EventNetworkDisconnect,
		EventAgentStarted, EventAgentStopping, EventAgentReconnected,
		EventJobStarted, EventJobCompleted,
		EventBackupStarted, EventBackupCompleted, EventRestoreStarted, EventRestoreCompleted,
		EventUpdateAvailable, EventUpdateStarted, EventUpdateCompleted, EventUpdateRollback,
		EventResourceRecovered:
		return SeverityInfo

	default:
		return SeverityDebug
	}
}

// ShouldPersist returns true if the event should be stored in database.
func ShouldPersist(eventType EventType) bool {
	switch eventType {
	case EventContainerCreate, EventContainerStart, EventContainerStop, EventContainerDie,
		EventContainerKill, EventContainerDestroy, EventContainerOOM,
		EventImagePull, EventImageDelete,
		EventVolumeCreate, EventVolumeDestroy,
		EventNetworkCreate, EventNetworkDestroy,
		EventAgentStarted, EventAgentStopping, EventAgentError,
		EventJobStarted, EventJobCompleted, EventJobFailed,
		EventSecurityScanCompleted, EventSecurityVulnFound, EventSecurityScoreChanged,
		EventBackupStarted, EventBackupCompleted, EventBackupFailed,
		EventRestoreStarted, EventRestoreCompleted, EventRestoreFailed,
		EventUpdateAvailable, EventUpdateStarted, EventUpdateCompleted, EventUpdateFailed, EventUpdateRollback,
		EventResourceCritical:
		return true
	default:
		return false
	}
}

// ShouldNotify returns true if the event should trigger notifications.
func ShouldNotify(eventType EventType) bool {
	switch eventType {
	case EventContainerDie, EventContainerOOM,
		EventAgentError, EventAgentStopping,
		EventJobFailed,
		EventSecurityVulnFound, EventSecurityScoreChanged,
		EventBackupFailed, EventRestoreFailed,
		EventUpdateAvailable, EventUpdateFailed, EventUpdateRollback,
		EventResourceCritical, EventResourceLow:
		return true
	default:
		return false
	}
}

// ============================================================================
// Event Store Interface
// ============================================================================

// EventStore defines the interface for event persistence.
type EventStore interface {
	// Save persists an event
	Save(ctx context.Context, event *Event) error
	// GetByID retrieves an event by ID
	GetByID(ctx context.Context, id string) (*Event, error)
	// List retrieves events with filters
	List(ctx context.Context, opts EventListOptions) ([]*Event, int64, error)
	// DeleteOlderThan deletes events older than a duration
	DeleteOlderThan(ctx context.Context, duration time.Duration) (int64, error)
}

// EventListOptions contains options for listing events.
type EventListOptions struct {
	HostID   *uuid.UUID
	AgentID  string
	Type     *EventType
	Severity *EventSeverity
	Since    *time.Time
	Until    *time.Time
	Page     int
	PerPage  int
	SortDesc bool
}

// Inventory types for periodic inventory sync
type Inventory struct {
	AgentID      string            `json:"agent_id"`
	HostID       string            `json:"host_id"`
	CollectedAt  time.Time         `json:"collected_at"`
	Containers   []ContainerInfo   `json:"containers,omitempty"`
	Images       []ImageInfo       `json:"images,omitempty"`
	Volumes      []VolumeInfo      `json:"volumes,omitempty"`
	Networks     []NetworkInfo     `json:"networks,omitempty"`
	SystemInfo   *SystemInfo       `json:"system_info,omitempty"`
}

// ContainerInfo for inventory
type ContainerInfo struct {
	ID         string            `json:"id"`
	Names      []string          `json:"names"`
	Image      string            `json:"image"`
	ImageID    string            `json:"image_id"`
	Command    string            `json:"command"`
	Created    int64             `json:"created"`
	State      string            `json:"state"`
	Status     string            `json:"status"`
	Ports      []PortBinding     `json:"ports,omitempty"`
	Labels     map[string]string `json:"labels,omitempty"`
	NetworkMode string           `json:"network_mode,omitempty"`
	Mounts     []MountInfo       `json:"mounts,omitempty"`
}

// PortBinding for container ports
type PortBinding struct {
	IP          string `json:"ip,omitempty"`
	PrivatePort uint16 `json:"private_port"`
	PublicPort  uint16 `json:"public_port,omitempty"`
	Type        string `json:"type"`
}

// MountInfo for container mounts
type MountInfo struct {
	Type        string `json:"type"`
	Name        string `json:"name,omitempty"`
	Source      string `json:"source"`
	Destination string `json:"destination"`
	Mode        string `json:"mode,omitempty"`
	RW          bool   `json:"rw"`
}

// ImageInfo for inventory
type ImageInfo struct {
	ID          string   `json:"id"`
	RepoTags    []string `json:"repo_tags"`
	RepoDigests []string `json:"repo_digests,omitempty"`
	Created     int64    `json:"created"`
	Size        int64    `json:"size"`
	VirtualSize int64    `json:"virtual_size"`
	Labels      map[string]string `json:"labels,omitempty"`
}

// VolumeInfo for inventory
type VolumeInfo struct {
	Name       string            `json:"name"`
	Driver     string            `json:"driver"`
	Mountpoint string            `json:"mountpoint"`
	CreatedAt  string            `json:"created_at,omitempty"`
	Labels     map[string]string `json:"labels,omitempty"`
	Scope      string            `json:"scope"`
	UsageData  *VolumeUsageData  `json:"usage_data,omitempty"`
}

// VolumeUsageData for volume size info
type VolumeUsageData struct {
	Size      int64 `json:"size"`
	RefCount  int64 `json:"ref_count"`
}

// NetworkInfo for inventory
type NetworkInfo struct {
	ID         string            `json:"id"`
	Name       string            `json:"name"`
	Driver     string            `json:"driver"`
	Scope      string            `json:"scope"`
	Internal   bool              `json:"internal"`
	Attachable bool              `json:"attachable"`
	Ingress    bool              `json:"ingress"`
	EnableIPv6 bool              `json:"enable_ipv6"`
	IPAM       *IPAMConfig       `json:"ipam,omitempty"`
	Labels     map[string]string `json:"labels,omitempty"`
	Containers map[string]string `json:"containers,omitempty"` // containerID -> name
}

// IPAMConfig for network IPAM
type IPAMConfig struct {
	Driver  string       `json:"driver,omitempty"`
	Config  []IPAMPool   `json:"config,omitempty"`
}

// IPAMPool for network subnet config
type IPAMPool struct {
	Subnet  string `json:"subnet,omitempty"`
	Gateway string `json:"gateway,omitempty"`
}

// SystemInfo for inventory
type SystemInfo struct {
	ID              string `json:"id"`
	Name            string `json:"name"`
	ServerVersion   string `json:"server_version"`
	APIVersion      string `json:"api_version"`
	OS              string `json:"os"`
	Arch            string `json:"arch"`
	KernelVersion   string `json:"kernel_version"`
	ContainersTotal int    `json:"containers_total"`
	ContainersRunning int  `json:"containers_running"`
	ContainersPaused int   `json:"containers_paused"`
	ContainersStopped int  `json:"containers_stopped"`
	Images          int    `json:"images"`
	MemoryTotal     int64  `json:"memory_total"`
	CPUs            int    `json:"cpus"`
}
