// Code generated by templ - DO NOT EDIT.

// templ: version: v0.3.977
// SPDX-License-Identifier: AGPL-3.0-or-later

// Copyright (c) 2024-2026 usulnet contributors

// https://github.com/fr4nsys/usulnet

package enterprise

//lint:file-ignore SA4006 This context is only used if a nested component is present.

import "github.com/a-h/templ"
import templruntime "github.com/a-h/templ/runtime"

import "github.com/fr4nsys/usulnet/internal/web/templates/layouts"

// OPAPoliciesData holds data for the OPA policies page.
type OPAPoliciesData struct {
	PageData layouts.PageData
}

func OPAPolicies(data OPAPoliciesData) templ.Component {
	return templruntime.GeneratedTemplate(func(templ_7745c5c3_Input templruntime.GeneratedComponentInput) (templ_7745c5c3_Err error) {
		templ_7745c5c3_W, ctx := templ_7745c5c3_Input.Writer, templ_7745c5c3_Input.Context
		if templ_7745c5c3_CtxErr := ctx.Err(); templ_7745c5c3_CtxErr != nil {
			return templ_7745c5c3_CtxErr
		}
		templ_7745c5c3_Buffer, templ_7745c5c3_IsBuffer := templruntime.GetBuffer(templ_7745c5c3_W)
		if !templ_7745c5c3_IsBuffer {
			defer func() {
				templ_7745c5c3_BufErr := templruntime.ReleaseBuffer(templ_7745c5c3_Buffer)
				if templ_7745c5c3_Err == nil {
					templ_7745c5c3_Err = templ_7745c5c3_BufErr
				}
			}()
		}
		ctx = templ.InitializeContext(ctx)
		templ_7745c5c3_Var1 := templ.GetChildren(ctx)
		if templ_7745c5c3_Var1 == nil {
			templ_7745c5c3_Var1 = templ.NopComponent
		}
		ctx = templ.ClearChildren(ctx)
		templ_7745c5c3_Var2 := templruntime.GeneratedTemplate(func(templ_7745c5c3_Input templruntime.GeneratedComponentInput) (templ_7745c5c3_Err error) {
			templ_7745c5c3_W, ctx := templ_7745c5c3_Input.Writer, templ_7745c5c3_Input.Context
			templ_7745c5c3_Buffer, templ_7745c5c3_IsBuffer := templruntime.GetBuffer(templ_7745c5c3_W)
			if !templ_7745c5c3_IsBuffer {
				defer func() {
					templ_7745c5c3_BufErr := templruntime.ReleaseBuffer(templ_7745c5c3_Buffer)
					if templ_7745c5c3_Err == nil {
						templ_7745c5c3_Err = templ_7745c5c3_BufErr
					}
				}()
			}
			ctx = templ.InitializeContext(ctx)
			templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 1, "<div x-data=\"")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			var templ_7745c5c3_Var3 string
			templ_7745c5c3_Var3, templ_7745c5c3_Err = templ.JoinStringErrs(opaAlpineInit(data.PageData.CSRFToken))
			if templ_7745c5c3_Err != nil {
				return templ.Error{Err: templ_7745c5c3_Err, FileName: `internal/web/templates/pages/enterprise/opa_policies.templ`, Line: 17, Col: 50}
			}
			_, templ_7745c5c3_Err = templ_7745c5c3_Buffer.WriteString(templ.EscapeString(templ_7745c5c3_Var3))
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 2, "\" x-init=\"init()\" class=\"space-y-6\"><!-- Header --><div class=\"flex items-center justify-between\"><div><h1 class=\"text-2xl font-display font-bold text-white\">OPA Policies</h1><p class=\"text-gray-400 mt-1\">Open Policy Agent rule-based policy engine for container compliance</p></div><div class=\"flex items-center gap-2\"><button @click=\"seedPolicies()\" :disabled=\"seeding\" class=\"btn-secondary flex items-center gap-2\"><i class=\"fas fa-database\" :class=\"seeding && 'animate-spin'\"></i> <span x-text=\"seeding ? 'Seeding...' : 'Seed Default Policies'\"></span></button></div></div><!-- Loading State --><div x-show=\"loading\" class=\"card p-12 text-center\"><i class=\"fas fa-spinner fa-spin text-2xl text-primary-400 mb-4\"></i><p class=\"text-gray-400\">Loading policies...</p></div><!-- Error State --><div x-show=\"error && !loading\" x-cloak class=\"card border-l-4 border-l-red-500 p-4\"><div class=\"flex items-center gap-3\"><i class=\"fas fa-exclamation-circle text-red-400\"></i><div><h3 class=\"text-sm font-medium text-red-400\">Failed to load policies</h3><p class=\"text-xs text-gray-400 mt-0.5\" x-text=\"error\"></p></div><button @click=\"fetchPolicies()\" class=\"ml-auto btn-secondary text-sm\">Retry</button></div></div><!-- Stats --><div x-show=\"!loading && !error\" x-cloak class=\"grid grid-cols-2 md:grid-cols-4 gap-4\"><div class=\"card p-3 text-center\"><i class=\"fas fa-shield-alt text-primary-400 text-lg mb-1\"></i><p class=\"text-xl font-bold text-white\" x-text=\"policies.length\"></p><p class=\"text-xs text-gray-400\">Total Policies</p></div><div class=\"card p-3 text-center\"><i class=\"fas fa-check-circle text-green-400 text-lg mb-1\"></i><p class=\"text-xl font-bold text-white\" x-text=\"policies.filter(p => p.is_enabled).length\"></p><p class=\"text-xs text-gray-400\">Enabled</p></div><div class=\"card p-3 text-center\"><i class=\"fas fa-pause-circle text-gray-400 text-lg mb-1\"></i><p class=\"text-xl font-bold text-white\" x-text=\"policies.filter(p => !p.is_enabled).length\"></p><p class=\"text-xs text-gray-400\">Disabled</p></div><div class=\"card p-3 text-center\"><i class=\"fas fa-tags text-blue-400 text-lg mb-1\"></i><p class=\"text-xl font-bold text-white\" x-text=\"[...new Set(policies.map(p => p.category))].length\"></p><p class=\"text-xs text-gray-400\">Categories</p></div></div><!-- Filters --><div x-show=\"!loading && !error && policies.length > 0\" x-cloak class=\"flex items-center gap-3\"><div><select x-model=\"categoryFilter\" class=\"input text-sm\"><option value=\"\">All Categories</option><template x-for=\"cat in categories\" :key=\"cat\"><option :value=\"cat\" x-text=\"cat.charAt(0).toUpperCase() + cat.slice(1)\"></option></template></select></div><div><select x-model=\"severityFilter\" class=\"input text-sm\"><option value=\"\">All Severities</option> <option value=\"critical\">Critical</option> <option value=\"high\">High</option> <option value=\"medium\">Medium</option> <option value=\"low\">Low</option></select></div><span class=\"text-sm text-gray-400\" x-text=\"filteredPolicies().length + ' policies'\"></span></div><!-- Policies Table --><div x-show=\"!loading && !error && policies.length > 0\" x-cloak class=\"card overflow-hidden\"><table class=\"w-full\"><thead><tr class=\"border-b border-dark-600\"><th class=\"text-left text-xs font-medium text-gray-400 uppercase px-4 py-3\">Policy</th><th class=\"text-left text-xs font-medium text-gray-400 uppercase px-4 py-3\">Category</th><th class=\"text-left text-xs font-medium text-gray-400 uppercase px-4 py-3\">Severity</th><th class=\"text-left text-xs font-medium text-gray-400 uppercase px-4 py-3\">Status</th><th class=\"text-left text-xs font-medium text-gray-400 uppercase px-4 py-3\">Enforcement</th><th class=\"text-left text-xs font-medium text-gray-400 uppercase px-4 py-3\">Actions</th></tr></thead> <tbody class=\"divide-y divide-dark-700\"><template x-for=\"policy in filteredPolicies()\" :key=\"policy.id\"><tr class=\"hover:bg-dark-700/50\"><td class=\"px-4 py-3\"><div class=\"font-medium text-white\" x-text=\"policy.name\"></div><div class=\"text-sm text-gray-400 mt-0.5 max-w-[300px] truncate\" x-text=\"policy.description\"></div></td><td class=\"px-4 py-3\"><span class=\"px-2 py-0.5 text-xs rounded\" :class=\"categoryClass(policy.category)\" x-text=\"policy.category\"></span></td><td class=\"px-4 py-3\"><span class=\"px-2 py-0.5 text-xs rounded\" :class=\"severityClass(policy.severity)\" x-text=\"policy.severity\"></span></td><td class=\"px-4 py-3\"><template x-if=\"policy.is_enabled\"><span class=\"px-2 py-0.5 text-xs bg-green-500/20 text-green-400 rounded flex items-center gap-1 w-fit\"><span class=\"w-1.5 h-1.5 rounded-full bg-green-400\"></span>Enabled</span></template><template x-if=\"!policy.is_enabled\"><span class=\"px-2 py-0.5 text-xs bg-gray-500/20 text-gray-400 rounded flex items-center gap-1 w-fit\"><span class=\"w-1.5 h-1.5 rounded-full bg-gray-400\"></span>Disabled</span></template></td><td class=\"px-4 py-3\"><span class=\"text-sm text-gray-300\" x-text=\"policy.is_enforcing ? 'Enforcing' : 'Warn (Audit Only)'\"></span></td><td class=\"px-4 py-3\"><button @click=\"openEvaluateModal(policy)\" class=\"p-1.5 text-gray-400 hover:text-primary-400 transition-colors\" title=\"Evaluate against container\"><i class=\"fas fa-play-circle text-sm\"></i></button></td></tr></template></tbody></table></div><!-- Empty State --><div x-show=\"!loading && !error && policies.length === 0\" x-cloak class=\"card p-12 text-center\"><i class=\"fas fa-shield-alt text-4xl text-gray-400 mb-4\"></i><h3 class=\"text-lg font-medium text-white mb-2\">No OPA Policies</h3><p class=\"text-gray-400 mb-4\">Seed default policies or create custom ones to enforce container compliance</p><button @click=\"seedPolicies()\" :disabled=\"seeding\" class=\"btn-primary\"><i class=\"fas fa-database mr-2\"></i>Seed Default Policies</button></div><!-- Evaluate Modal --><div x-show=\"showEvaluateModal\" x-cloak class=\"fixed inset-0 z-50 flex items-center justify-center bg-black/60\"><div class=\"bg-dark-800 rounded-xl shadow-xl border border-dark-600 w-full max-w-md mx-4\"><div class=\"flex items-center justify-between p-6 border-b border-dark-600\"><h2 class=\"text-lg font-display font-bold text-white\">Evaluate Policy</h2><button @click=\"showEvaluateModal = false\" class=\"text-gray-400 hover:text-white\"><i class=\"fas fa-times\"></i></button></div><div class=\"p-6 space-y-4\"><div x-show=\"selectedPolicy\"><p class=\"text-sm text-gray-400 mb-1\">Policy</p><p class=\"text-white font-medium\" x-text=\"selectedPolicy?.name\"></p></div><div><label class=\"block text-sm font-medium text-gray-300 mb-1\">Container ID</label> <input type=\"text\" x-model=\"evaluateContainerID\" class=\"input w-full font-mono\" placeholder=\"Enter container ID or name\"></div><!-- Evaluation Results --><div x-show=\"evaluateResult\" x-cloak class=\"mt-4\"><h4 class=\"text-sm font-medium text-gray-300 mb-2\">Results</h4><pre class=\"bg-dark-900 border border-dark-600 rounded-lg p-3 text-sm text-gray-300 font-mono overflow-x-auto max-h-48 overflow-y-auto whitespace-pre-wrap\" x-text=\"evaluateResult ? JSON.stringify(evaluateResult, null, 2) : ''\"></pre></div><div class=\"flex justify-end gap-3 pt-4 border-t border-dark-600\"><button @click=\"showEvaluateModal = false\" class=\"btn-secondary\">Cancel</button> <button @click=\"evaluatePolicy()\" :disabled=\"evaluating || !evaluateContainerID\" class=\"btn-primary\"><i class=\"fas fa-play mr-2\" :class=\"evaluating && 'animate-spin'\"></i> <span x-text=\"evaluating ? 'Evaluating...' : 'Evaluate'\"></span></button></div></div></div></div></div>")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			return nil
		})
		templ_7745c5c3_Err = layouts.Base(data.PageData).Render(templ.WithChildren(ctx, templ_7745c5c3_Var2), templ_7745c5c3_Buffer)
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		return nil
	})
}

func opaAlpineInit(csrfToken string) string {
	return `{
		policies: [],
		loading: true,
		error: null,
		seeding: false,
		categoryFilter: '',
		severityFilter: '',
		showEvaluateModal: false,
		selectedPolicy: null,
		evaluateContainerID: '',
		evaluateResult: null,
		evaluating: false,
		csrfToken: '` + csrfToken + `',

		get categories() {
			return [...new Set(this.policies.map(p => p.category))].sort();
		},

		init() {
			this.fetchPolicies();
		},

		async fetchPolicies() {
			this.loading = true;
			this.error = null;
			try {
				const resp = await fetch('/api/v1/opa/policies');
				if (!resp.ok) { var eb = await resp.json().catch(function() { return null; }); throw new Error((eb && eb.error) ? eb.error : 'HTTP ' + resp.status); }
				const data = await resp.json();
				this.policies = Array.isArray(data) ? data : [];
			} catch (e) {
				this.error = e.message || 'Failed to fetch policies';
				this.policies = [];
			} finally {
				this.loading = false;
			}
		},

		filteredPolicies() {
			return this.policies.filter(p => {
				if (this.categoryFilter && p.category !== this.categoryFilter) return false;
				if (this.severityFilter && p.severity !== this.severityFilter) return false;
				return true;
			});
		},

		async seedPolicies() {
			this.seeding = true;
			try {
				const resp = await fetch('/api/v1/opa/policies/seed', {
					method: 'POST',
					headers: { 'X-CSRF-Token': this.csrfToken }
				});
				if (!resp.ok) { var eb = await resp.json().catch(function() { return null; }); throw new Error((eb && eb.error) ? eb.error : 'HTTP ' + resp.status); }
				if (window.usulnet) { window.usulnet.toast('Default policies seeded', 'success'); }
				await this.fetchPolicies();
			} catch (e) {
				var msg = e.message || 'Failed to seed policies';
				if (window.usulnet) { window.usulnet.toast(msg, 'error'); } else { console.error(msg); }
			} finally {
				this.seeding = false;
			}
		},

		openEvaluateModal(policy) {
			this.selectedPolicy = policy;
			this.evaluateContainerID = '';
			this.evaluateResult = null;
			this.showEvaluateModal = true;
		},

		async evaluatePolicy() {
			if (!this.evaluateContainerID) return;
			this.evaluating = true;
			this.evaluateResult = null;
			try {
				const resp = await fetch('/api/v1/opa/evaluate/container/' + encodeURIComponent(this.evaluateContainerID), {
					method: 'POST',
					headers: { 'X-CSRF-Token': this.csrfToken }
				});
				if (!resp.ok) { var eb = await resp.json().catch(function() { return null; }); throw new Error((eb && eb.error) ? eb.error : 'HTTP ' + resp.status); }
				this.evaluateResult = await resp.json();
				if (window.usulnet) { window.usulnet.toast('Evaluation complete', 'success'); }
			} catch (e) {
				var msg = e.message || 'Evaluation failed';
				if (window.usulnet) { window.usulnet.toast(msg, 'error'); } else { console.error(msg); }
			} finally {
				this.evaluating = false;
			}
		},

		severityClass(severity) {
			switch (severity) {
				case 'critical': return 'bg-red-500/20 text-red-400';
				case 'high': return 'bg-orange-500/20 text-orange-400';
				case 'medium': return 'bg-yellow-500/20 text-yellow-400';
				case 'low': return 'bg-blue-500/20 text-blue-400';
				default: return 'bg-gray-500/20 text-gray-400';
			}
		},

		categoryClass(category) {
			switch (category) {
				case 'admission': return 'bg-red-500/20 text-red-400';
				case 'runtime': return 'bg-orange-500/20 text-orange-400';
				case 'network': return 'bg-blue-500/20 text-blue-400';
				case 'image': return 'bg-purple-500/20 text-purple-400';
				case 'general': return 'bg-green-500/20 text-green-400';
				default: return 'bg-gray-500/20 text-gray-400';
			}
		}
	}`
}

var _ = templruntime.GeneratedTemplate
