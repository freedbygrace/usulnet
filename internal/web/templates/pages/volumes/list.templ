package volumes

import (
	"github.com/fr4nsys/usulnet/internal/web/templates/layouts"
	"github.com/fr4nsys/usulnet/internal/web/templates/components"
)

type VolumesListData struct {
	PageData   layouts.PageData
	Volumes    []Volume
	TotalSize  string
	Filters    VolumeFilters
	Pagination PaginationData
}

type Volume struct {
	Name         string
	Driver       string
	Mountpoint   string
	Scope        string
	Labels       map[string]string
	Created      string
	CreatedAgo   string
	InUse        bool
	Size         int64
	SizeHuman    string
	Containers   int
}

type VolumeFilters struct {
	Search string
	Driver string
	InUse  string
	Sort   string
	Dir    string
}

type PaginationData struct {
	CurrentPage int
	TotalPages  int
	TotalItems  int
	PerPage     int
}

templ VolumesList(data VolumesListData) {
	@layouts.Base(data.PageData) {
		<!-- Page Header -->
		<div class="flex items-center justify-between mb-6">
			<div>
				<div class="flex items-center gap-3">
					<h1 class="text-2xl font-bold font-display text-white">Volumes</h1>
					@components.HostBadge(data.PageData.ActiveHostName)
				</div>
				<p class="text-gray-400 mt-1">Manage Docker volumes ({ data.TotalSize } total)</p>
			</div>
			<div class="flex items-center gap-3">
				<a href="/volumes/new" class="btn-primary">
					<i class="fas fa-plus mr-2"></i>
					New Volume
				</a>
				<button 
					hx-post="/volumes/prune"
					hx-confirm="Remove all unused volumes? This cannot be undone."
					hx-swap="none"
					class="px-4 py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-lg transition-colors"
				>
					<i class="fas fa-broom mr-2"></i>
					Prune
				</button>
			</div>
		</div>

		<!-- Filters -->
		<div class="bg-dark-800 rounded-xl border border-dark-600 p-4 mb-6">
			<div class="flex flex-col md:flex-row gap-4">
				<!-- Search -->
				<div class="flex-1">
					<div class="relative">
						<input 
							type="search"
							name="search"
							placeholder="Search volumes..."
							value={ data.Filters.Search }
							class="w-full pl-10 pr-4 py-2 bg-dark-700 border border-dark-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500/50"
							hx-get="/volumes"
							hx-trigger="keyup changed delay:300ms"
							hx-target="#volume-table"
							hx-select="#volume-table"
							hx-push-url="true"
						/>
						<i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
					</div>
				</div>
				
				<!-- Driver Filter -->
				<div class="w-full md:w-40">
					<select 
						name="driver"
						class="w-full px-4 py-2 bg-dark-700 border border-dark-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary-500/50 appearance-none"
						hx-get="/volumes"
						hx-trigger="change"
						hx-target="#volume-table"
						hx-select="#volume-table"
						hx-push-url="true"
					>
						<option value="" selected?={ data.Filters.Driver == "" }>All Drivers</option>
						<option value="local" selected?={ data.Filters.Driver == "local" }>Local</option>
						<option value="nfs" selected?={ data.Filters.Driver == "nfs" }>NFS</option>
					</select>
				</div>
				
				<!-- In Use Filter -->
				<div class="w-full md:w-40">
					<select 
						name="in_use"
						class="w-full px-4 py-2 bg-dark-700 border border-dark-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary-500/50 appearance-none"
						hx-get="/volumes"
						hx-trigger="change"
						hx-target="#volume-table"
						hx-select="#volume-table"
						hx-push-url="true"
					>
						<option value="" selected?={ data.Filters.InUse == "" }>All</option>
						<option value="true" selected?={ data.Filters.InUse == "true" }>In Use</option>
						<option value="false" selected?={ data.Filters.InUse == "false" }>Unused</option>
					</select>
				</div>
			</div>
		</div>

		<!-- Volumes Table -->
		<div id="volume-table" class="bg-dark-800 rounded-xl border border-dark-600 overflow-hidden">
			@components.Table() {
				@components.TableHead() {
					@components.TableHeaderSortable("Name", "name", data.Filters.Sort, data.Filters.Dir)
					@components.TableHeader("Driver", "w-24")
					@components.TableHeaderSortable("Size", "size", data.Filters.Sort, data.Filters.Dir)
					@components.TableHeaderSortable("Created", "created", data.Filters.Sort, data.Filters.Dir)
					@components.TableHeader("Used", "w-20")
					@components.TableHeader("Actions", "w-32")
				}
				@components.TableBody() {
					if len(data.Volumes) == 0 {
						@components.TableEmpty("No volumes found", "fa-hdd")
					} else {
						for _, vol := range data.Volumes {
							@volumeRow(vol)
						}
					}
				}
			}
			
			if data.Pagination.TotalPages > 1 {
				@components.Pagination(
					data.Pagination.CurrentPage,
					data.Pagination.TotalPages,
					data.Pagination.TotalItems,
					"/volumes",
				)
			}
		</div>
	}
}

templ volumeRow(vol Volume) {
	<tr class="hover:bg-dark-700/50 transition-colors group">
		<td class="px-4 py-3">
			<div class="flex items-center gap-3">
				<div class={ "w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0", volumeIcon(vol.InUse) }>
					<i class="fas fa-hdd"></i>
				</div>
				<div>
					<a href={ templ.SafeURL("/volumes/" + vol.Name) } class="font-medium text-white hover:text-primary-400 transition-colors font-mono">
						{ truncateName(vol.Name, 40) }
					</a>
					<p class="text-xs text-gray-500 truncate max-w-xs">{ vol.Mountpoint }</p>
				</div>
			</div>
		</td>
		<td class="px-4 py-3">
			<span class="px-2 py-1 text-xs bg-dark-600 text-gray-300 rounded">
				{ vol.Driver }
			</span>
		</td>
		<td class="px-4 py-3 text-sm text-gray-300 font-mono">
			if vol.SizeHuman != "" && vol.SizeHuman != "0 B" {
				{ vol.SizeHuman }
			} else {
				<span class="text-gray-500">-</span>
			}
		</td>
		<td class="px-4 py-3 text-sm text-gray-400">
			{ vol.CreatedAgo }
		</td>
		<td class="px-4 py-3">
			if vol.InUse {
				<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-green-500/10 text-green-400">
					<span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
					Yes
				</span>
			} else {
				<span class="text-gray-500 text-sm">-</span>
			}
		</td>
		<td class="px-4 py-3">
			<div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
				<a 
					href={ templ.SafeURL("/volumes/" + vol.Name) }
					class="p-2 text-gray-400 hover:text-primary-400 hover:bg-primary-500/10 rounded-lg transition-colors"
					title="Details"
				>
					<i class="fas fa-info-circle text-sm"></i>
				</a>
				if !vol.InUse {
					<button
						hx-post={ "/volumes/" + vol.Name + "/remove" }
						hx-confirm="Remove this volume? All data will be lost."
						hx-target="closest tr"
						hx-swap="outerHTML swap:200ms"
						class="p-2 text-gray-400 hover:text-red-400 hover:bg-red-500/10 rounded-lg transition-colors"
						title="Remove"
					>
						<i class="fas fa-trash text-sm"></i>
					</button>
				}
			</div>
		</td>
	</tr>
}

func volumeIcon(inUse bool) string {
	if inUse {
		return "bg-purple-500/20 text-purple-400"
	}
	return "bg-gray-500/20 text-gray-400"
}

func truncateName(name string, maxLen int) string {
	if len(name) > maxLen {
		return name[:maxLen-3] + "..."
	}
	return name
}
