package containers

import (
	"fmt"
	
	"github.com/fr4nsys/usulnet/internal/web/templates/layouts"
	"github.com/fr4nsys/usulnet/internal/web/templates/components"
)

type ContainersListData struct {
	PageData   layouts.PageData
	Containers []Container
	Filters    ContainerFilters
	Pagination PaginationData
}

type Container struct {
	ID           string
	Name         string
	Image        string
	ImageID      string
	State        string
	Status       string
	Created      string
	CreatedAgo   string
	Ports        []PortMapping
	Networks     []string
	Mounts       int
	Labels       map[string]string
	SecurityScore int
	HasUpdates   bool
}

type PortMapping struct {
	Internal int
	External int
	Protocol string
	IP       string
}

type ContainerFilters struct {
	Search string
	State  string
	Sort   string
	Dir    string
}

type PaginationData struct {
	CurrentPage int
	TotalPages  int
	TotalItems  int
	PerPage     int
}

templ ContainersList(data ContainersListData) {
	@layouts.Base(data.PageData) {
		<div x-data="bulkContainerActions()">
			<!-- Page Header -->
			<div class="flex items-center justify-between mb-6">
				<div>
					<div class="flex items-center gap-3">
						<h1 class="text-2xl font-bold font-display text-white">Containers</h1>
						@components.HostBadge(data.PageData.ActiveHostName)
					</div>
					<p class="text-gray-400 mt-1">Manage your Docker containers</p>
				</div>
				<div class="flex items-center gap-3">
					<a href="/containers/new" class="btn-primary">
						<i class="fas fa-plus"></i>
						New Container
					</a>
				</div>
			</div>

			<!-- Bulk Actions Toolbar (shows when containers selected) -->
			<div
				x-show="selected.length > 0"
				x-transition:enter="transition ease-out duration-200"
				x-transition:enter-start="opacity-0 -translate-y-2"
				x-transition:enter-end="opacity-100 translate-y-0"
				x-transition:leave="transition ease-in duration-150"
				x-transition:leave-start="opacity-100 translate-y-0"
				x-transition:leave-end="opacity-0 -translate-y-2"
				class="bg-primary-900/30 border border-primary-500/30 rounded-xl p-4 mb-4"
				style="display: none;"
			>
				<div class="flex flex-wrap items-center gap-3">
					<span class="text-primary-400 font-medium">
						<i class="fas fa-check-square mr-2"></i>
						<span x-text="selected.length"></span> container(s) selected
					</span>
					<div class="flex-1"></div>
					<div class="flex flex-wrap items-center gap-2">
						<button
							@click="bulkAction('start')"
							class="px-3 py-1.5 bg-green-600 hover:bg-green-500 text-white text-sm rounded-lg transition-colors"
						>
							<i class="fas fa-play mr-1"></i> Start
						</button>
						<button
							@click="bulkAction('stop')"
							class="px-3 py-1.5 bg-red-600 hover:bg-red-500 text-white text-sm rounded-lg transition-colors"
						>
							<i class="fas fa-stop mr-1"></i> Stop
						</button>
						<button
							@click="bulkAction('restart')"
							class="px-3 py-1.5 bg-yellow-600 hover:bg-yellow-500 text-white text-sm rounded-lg transition-colors"
						>
							<i class="fas fa-redo mr-1"></i> Restart
						</button>
						<button
							@click="bulkAction('pause')"
							class="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 text-white text-sm rounded-lg transition-colors"
						>
							<i class="fas fa-pause mr-1"></i> Pause
						</button>
						<button
							@click="bulkAction('unpause')"
							class="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 text-white text-sm rounded-lg transition-colors"
						>
							<i class="fas fa-play mr-1"></i> Unpause
						</button>
						<button
							@click="bulkAction('kill')"
							class="px-3 py-1.5 bg-orange-600 hover:bg-orange-500 text-white text-sm rounded-lg transition-colors"
						>
							<i class="fas fa-skull mr-1"></i> Kill
						</button>
						<button
							@click="confirmRemove()"
							class="px-3 py-1.5 bg-red-700 hover:bg-red-600 text-white text-sm rounded-lg transition-colors"
						>
							<i class="fas fa-trash mr-1"></i> Remove
						</button>
						<button
							@click="clearSelection()"
							class="px-3 py-1.5 bg-dark-600 hover:bg-dark-500 text-gray-300 text-sm rounded-lg transition-colors"
						>
							<i class="fas fa-times mr-1"></i> Clear
						</button>
					</div>
				</div>
			</div>

			<!-- Filters -->
			<div class="bg-dark-800 rounded-xl border border-dark-600 p-4 mb-6">
				<div class="flex flex-col md:flex-row gap-4">
					<!-- Search -->
					<div class="flex-1">
						<div class="relative">
							<input
								type="search"
								name="search"
								placeholder="Search containers..."
								value={ data.Filters.Search }
								class="w-full pl-10 pr-4 py-2 bg-dark-700 border border-dark-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500/50 focus:border-primary-500"
								hx-get="/containers"
								hx-trigger="keyup changed delay:300ms"
								hx-target="#container-table"
								hx-select="#container-table"
								hx-push-url="true"
							/>
							<i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
						</div>
					</div>

					<!-- State Filter -->
					<div class="w-full md:w-48">
						<select
							name="state"
							class="w-full px-4 py-2 bg-dark-700 border border-dark-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary-500/50 appearance-none"
							hx-get="/containers"
							hx-trigger="change"
							hx-target="#container-table"
							hx-select="#container-table"
							hx-push-url="true"
						>
							<option value="" selected?={ data.Filters.State == "" }>All States</option>
							<option value="running" selected?={ data.Filters.State == "running" }>Running</option>
							<option value="exited" selected?={ data.Filters.State == "exited" }>Exited</option>
							<option value="paused" selected?={ data.Filters.State == "paused" }>Paused</option>
							<option value="restarting" selected?={ data.Filters.State == "restarting" }>Restarting</option>
						</select>
					</div>
				</div>
			</div>

			<!-- Hidden form for bulk actions -->
			<form id="bulk-action-form" method="post" style="display: none;">
				<input type="hidden" name="csrf_token" value={ data.PageData.CSRFToken }/>
				<template x-for="id in selected" :key="id">
					<input type="hidden" name="container_ids" :value="id"/>
				</template>
			</form>

			<!-- Container Table -->
			<div id="container-table" class="bg-dark-800 rounded-xl border border-dark-600 overflow-hidden">
				@components.Table() {
					@components.TableHead() {
						<th class="w-10 px-4 py-3">
							<input
								type="checkbox"
								class="checkbox"
								@click="toggleAll($event)"
							:checked={ fmt.Sprintf("selected.length === %d && selected.length > 0", len(data.Containers)) }
							:indeterminate={ fmt.Sprintf("selected.length > 0 && selected.length < %d", len(data.Containers)) }
							/>
						</th>
						@components.TableHeaderSortable("Name", "name", data.Filters.Sort, data.Filters.Dir)
						@components.TableHeader("Status", "w-32")
						@components.TableHeaderSortable("Image", "image", data.Filters.Sort, data.Filters.Dir)
						@components.TableHeader("Ports", "")
						@components.TableHeader("Created", "w-32")
						@components.TableHeader("Actions", "w-40")
					}
					@components.TableBody() {
						if len(data.Containers) == 0 {
							@components.TableEmpty("No containers found", "fa-cube")
						} else {
							for _, c := range data.Containers {
								@containerRow(c)
							}
						}
					}
				}

				if data.Pagination.TotalPages > 1 {
					@components.Pagination(
						data.Pagination.CurrentPage,
						data.Pagination.TotalPages,
						data.Pagination.TotalItems,
						"/containers",
					)
				}
			</div>

			<!-- Confirm Remove Modal -->
			<div
				x-show="showRemoveModal"
				x-transition:enter="transition ease-out duration-200"
				x-transition:enter-start="opacity-0"
				x-transition:enter-end="opacity-100"
				x-transition:leave="transition ease-in duration-150"
				x-transition:leave-start="opacity-100"
				x-transition:leave-end="opacity-0"
				class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"
				style="display: none;"
				@click.self="showRemoveModal = false"
			>
				<div class="bg-dark-800 rounded-xl border border-dark-600 p-6 max-w-md w-full mx-4 shadow-2xl">
					<h3 class="text-lg font-semibold text-white mb-4">
						<i class="fas fa-exclamation-triangle text-red-400 mr-2"></i>
						Remove Containers
					</h3>
					<p class="text-gray-400 mb-4">
						Are you sure you want to remove <span class="text-white font-medium" x-text="selected.length"></span> container(s)?
						This action cannot be undone.
					</p>
					<div class="flex items-center gap-2 mb-4">
						<input type="checkbox" id="force-remove" x-model="forceRemove" class="checkbox"/>
						<label for="force-remove" class="text-gray-300 text-sm">Force remove (stop running containers)</label>
					</div>
					<div class="flex justify-end gap-3">
						<button
							@click="showRemoveModal = false"
							class="px-4 py-2 bg-dark-600 hover:bg-dark-500 text-gray-300 rounded-lg transition-colors"
						>
							Cancel
						</button>
						<button
							@click="bulkAction('remove')"
							class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg transition-colors"
						>
							<i class="fas fa-trash mr-2"></i>Remove
						</button>
					</div>
				</div>
			</div>
		</div>

		<script>
			function bulkContainerActions() {
				return {
					selected: [],
					showRemoveModal: false,
					forceRemove: false,

					toggleAll(event) {
						const checkboxes = document.querySelectorAll('tbody input[type="checkbox"]');
						if (event.target.checked) {
							this.selected = Array.from(checkboxes).map(cb => cb.value);
						} else {
							this.selected = [];
						}
						checkboxes.forEach(cb => cb.checked = event.target.checked);
					},

					toggleSelect(id) {
						const index = this.selected.indexOf(id);
						if (index === -1) {
							this.selected.push(id);
						} else {
							this.selected.splice(index, 1);
						}
					},

					clearSelection() {
						this.selected = [];
						document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
					},

					confirmRemove() {
						this.showRemoveModal = true;
					},

					bulkAction(action) {
						if (this.selected.length === 0) return;

						const form = document.getElementById('bulk-action-form');
						// Preserve CSRF token before clearing
						const csrfInput = form.querySelector('input[name="csrf_token"]');
						const csrfValue = csrfInput ? csrfInput.value : '';

						// Clear existing dynamic inputs
						form.innerHTML = '';

						// Re-add CSRF token
						const csrf = document.createElement('input');
						csrf.type = 'hidden';
						csrf.name = 'csrf_token';
						csrf.value = csrfValue;
						form.appendChild(csrf);

						// Add container IDs
						this.selected.forEach(id => {
							const input = document.createElement('input');
							input.type = 'hidden';
							input.name = 'container_ids';
							input.value = id;
							form.appendChild(input);
						});

						// Add force flag for remove
						if (action === 'remove' && this.forceRemove) {
							const forceInput = document.createElement('input');
							forceInput.type = 'hidden';
							forceInput.name = 'force';
							forceInput.value = 'true';
							form.appendChild(forceInput);
						}

						form.action = '/containers/bulk/' + action;
						htmx.ajax('POST', form.action, {source: form, values: htmx.values(form)});

						this.showRemoveModal = false;
						this.selected = [];
						document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
					}
				}
			}
		</script>
	}
}

templ containerRow(c Container) {
	<tr class="hover:bg-dark-700/50 transition-colors group">
		<td class="px-4 py-3">
			<input
				type="checkbox"
				class="checkbox"
				value={ c.ID }
				@change={ "toggleSelect('" + c.ID + "')" }
				:checked={ "selected.includes('" + c.ID + "')" }
			/>
		</td>
		<td class="px-4 py-3">
			<div class="flex items-center gap-3">
				<div class={ "w-2.5 h-2.5 rounded-full flex-shrink-0", stateColor(c.State) }></div>
				<div>
					<a href={ templ.SafeURL("/containers/" + c.ID) } class="font-medium text-white hover:text-primary-400 transition-colors">
						{ c.Name }
					</a>
					<p class="text-xs text-gray-500 font-mono">{ shortID(c.ID) }</p>
				</div>
			</div>
		</td>
		<td class="px-4 py-3">
			<span class={ "inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium", stateBadge(c.State) }>
				<span class={ "w-1.5 h-1.5 rounded-full", stateColor(c.State) }></span>
				{ c.State }
			</span>
		</td>
		<td class="px-4 py-3">
			<div class="flex items-center gap-2">
				<span class="text-gray-300 font-mono text-sm truncate max-w-xs">{ c.Image }</span>
				if c.HasUpdates {
					<span class="px-1.5 py-0.5 text-[10px] bg-primary-500/20 text-primary-400 rounded" title="Update available">
						<i class="fas fa-arrow-up"></i>
					</span>
				}
			</div>
		</td>
		<td class="px-4 py-3">
			if len(c.Ports) > 0 {
				<div class="flex flex-wrap gap-1">
					for i, p := range c.Ports {
						if i < 3 {
							<span class="px-2 py-0.5 text-xs bg-dark-700 text-gray-300 rounded font-mono">
								{ formatPort(p) }
							</span>
						}
					}
					if len(c.Ports) > 3 {
						<span class="px-2 py-0.5 text-xs bg-dark-700 text-gray-500 rounded">
							+{ fmt.Sprintf("%d", len(c.Ports)-3) } more
						</span>
					}
				</div>
			} else {
				<span class="text-gray-500 text-sm">-</span>
			}
		</td>
		<td class="px-4 py-3 text-sm text-gray-400">
			{ c.CreatedAgo }
		</td>
		<td class="px-4 py-3">
			<div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
				if c.State == "running" {
					<button 
						hx-post={ "/containers/" + c.ID + "/stop" }
						hx-swap="none"
						class="p-2 text-gray-400 hover:text-red-400 hover:bg-red-500/10 rounded-lg transition-colors"
						title="Stop"
					>
						<i class="fas fa-stop text-sm"></i>
					</button>
					<button 
						hx-post={ "/containers/" + c.ID + "/restart" }
						hx-swap="none"
						class="p-2 text-gray-400 hover:text-yellow-400 hover:bg-yellow-500/10 rounded-lg transition-colors"
						title="Restart"
					>
						<i class="fas fa-redo text-sm"></i>
					</button>
				} else {
					<button 
						hx-post={ "/containers/" + c.ID + "/start" }
						hx-swap="none"
						class="p-2 text-gray-400 hover:text-green-400 hover:bg-green-500/10 rounded-lg transition-colors"
						title="Start"
					>
						<i class="fas fa-play text-sm"></i>
					</button>
				}
				<a 
					href={ templ.SafeURL("/containers/" + c.ID + "/logs") }
					class="p-2 text-gray-400 hover:text-primary-400 hover:bg-primary-500/10 rounded-lg transition-colors"
					title="Logs"
				>
					<i class="fas fa-file-alt text-sm"></i>
				</a>
				<a 
					href={ templ.SafeURL("/containers/" + c.ID + "/exec") }
					class="p-2 text-gray-400 hover:text-primary-400 hover:bg-primary-500/10 rounded-lg transition-colors"
					title="Terminal"
				>
					<i class="fas fa-terminal text-sm"></i>
				</a>
				<div x-data="{ open: false }" class="relative">
					<button 
						@click="open = !open"
						class="p-2 text-gray-400 hover:text-white hover:bg-dark-600 rounded-lg transition-colors"
					>
						<i class="fas fa-ellipsis-v text-sm"></i>
					</button>
					<div 
						x-show="open"
						x-transition
						@click.outside="open = false"
						class="absolute right-0 mt-1 w-48 bg-dark-800 rounded-lg border border-dark-600 shadow-xl py-1 z-10"
						style="display: none;"
					>
						<a href={ templ.SafeURL("/containers/" + c.ID) } class="flex items-center gap-2 px-4 py-2 text-sm text-gray-300 hover:bg-dark-700">
							<i class="fas fa-info-circle w-4"></i> Details
						</a>
						<a href={ templ.SafeURL("/containers/" + c.ID + "/inspect") } class="flex items-center gap-2 px-4 py-2 text-sm text-gray-300 hover:bg-dark-700">
							<i class="fas fa-code w-4"></i> Inspect
						</a>
						<a href={ templ.SafeURL("/containers/" + c.ID + "/stats") } class="flex items-center gap-2 px-4 py-2 text-sm text-gray-300 hover:bg-dark-700">
							<i class="fas fa-chart-line w-4"></i> Stats
						</a>
						<hr class="my-1 border-dark-600"/>
						<button
							hx-post={ "/containers/" + c.ID + "/remove" }
							hx-confirm="Are you sure you want to remove this container?"
							hx-target="closest tr"
							hx-swap="outerHTML swap:200ms"
							class="w-full flex items-center gap-2 px-4 py-2 text-sm text-red-400 hover:bg-red-500/10"
						>
							<i class="fas fa-trash w-4"></i> Remove
						</button>
					</div>
				</div>
			</div>
		</td>
	</tr>
}

func stateColor(state string) string {
	switch state {
	case "running":
		return "bg-green-500"
	case "paused":
		return "bg-yellow-500"
	case "restarting":
		return "bg-blue-500"
	default:
		return "bg-red-500"
	}
}

func stateBadge(state string) string {
	switch state {
	case "running":
		return "bg-green-500/10 text-green-400"
	case "paused":
		return "bg-yellow-500/10 text-yellow-400"
	case "restarting":
		return "bg-blue-500/10 text-blue-400"
	default:
		return "bg-red-500/10 text-red-400"
	}
}

func shortID(id string) string {
	if len(id) > 12 {
		return id[:12]
	}
	return id
}

func formatPort(p PortMapping) string {
	if p.External > 0 {
		return fmt.Sprintf("%d:%d/%s", p.External, p.Internal, p.Protocol)
	}
	return fmt.Sprintf("%d/%s", p.Internal, p.Protocol)
}
