package connections

import (
	"fmt"
	"github.com/fr4nsys/usulnet/internal/web/templates/layouts"
)

type LDAPConnectionData struct {
	ID          string
	Name        string
	Host        string
	Port        int
	BaseDN      string
	BindDN      string
	UseSSL      bool
	UseTLS      bool
	Status      string
	LastChecked string
}

type LDAPEntryData struct {
	DN          string
	ObjectClass []string
	Attributes  map[string][]string
	HasChildren bool
}

type LDAPAttributeData struct {
	Name   string
	Values []string
	Binary bool
}

type LDAPBrowserData struct {
	PageData     layouts.PageData
	Connection   LDAPConnectionData
	BaseDN       string
	CurrentDN    string
	Entries      []LDAPEntryData
	CurrentEntry *LDAPEntryData
	Attributes   []LDAPAttributeData
	Breadcrumbs  []string
	WriteEnabled bool
	SearchFilter string
	SearchScope  string
}

type LDAPConnectionsListData struct {
	PageData    layouts.PageData
	Connections []LDAPConnectionData
}

// LDAPConnectionsList renders the LDAP connections list page.
templ LDAPConnectionsList(data LDAPConnectionsListData) {
	@layouts.Base(data.PageData) {
		<div class="space-y-6">
			<!-- Header -->
			<div class="flex items-center justify-between">
				<div>
					<h1 class="text-2xl font-display font-bold text-white">LDAP Connections</h1>
					<p class="text-gray-400 mt-1">Browse and manage LDAP directories</p>
				</div>
				<button onclick="showNewLDAPModal()" class="btn-primary">
					<i class="fas fa-plus mr-2"></i>New Connection
				</button>
			</div>

			<!-- Connection Cards -->
			<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
				if len(data.Connections) == 0 {
					<div class="col-span-full card p-8 text-center">
						<i class="fas fa-sitemap text-4xl text-gray-400 mb-4"></i>
						<p class="text-gray-400">No LDAP connections configured</p>
						<button onclick="showNewLDAPModal()" class="btn-primary mt-4">
							<i class="fas fa-plus mr-2"></i>Add Connection
						</button>
					</div>
				}
				for _, conn := range data.Connections {
					<div class="card p-4 hover:border-primary-500/50 transition-colors">
						<div class="flex items-start justify-between mb-3">
							<div class="flex items-center gap-3">
								<div class="w-10 h-10 rounded-lg bg-indigo-500/20 flex items-center justify-center">
									<i class="fas fa-sitemap text-indigo-400"></i>
								</div>
								<div>
									<h3 class="text-white font-medium">{ conn.Name }</h3>
									<p class="text-gray-500 text-xs">LDAP</p>
								</div>
							</div>
							if conn.Status == "connected" {
								<span class="flex items-center gap-1.5 text-xs text-green-400">
									<span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
									Connected
								</span>
							} else {
								<span class="flex items-center gap-1.5 text-xs text-gray-400">
									<span class="w-1.5 h-1.5 rounded-full bg-gray-500"></span>
									Offline
								</span>
							}
						</div>
						<div class="space-y-1 mb-3">
							<p class="text-gray-400 text-sm">{ conn.Host }:{ fmt.Sprintf("%d", conn.Port) }</p>
							<p class="text-gray-500 text-xs truncate">Base: { conn.BaseDN }</p>
						</div>
						<div class="flex items-center justify-between pt-3 border-t border-dark-600">
							<div class="flex items-center gap-2">
								if conn.UseSSL {
									<span class="text-xs px-1.5 py-0.5 bg-green-500/10 text-green-400 rounded">SSL</span>
								}
								if conn.UseTLS {
									<span class="text-xs px-1.5 py-0.5 bg-blue-500/10 text-blue-400 rounded">TLS</span>
								}
							</div>
							<div class="flex items-center gap-1">
								<a href={ templ.SafeURL(fmt.Sprintf("/connections/ldap/%s", conn.ID)) }
									class="p-2 text-gray-400 hover:text-white hover:bg-dark-600 rounded-lg"
									title="Browse">
									<i class="fas fa-folder-tree"></i>
								</a>
								<a href={ templ.SafeURL(fmt.Sprintf("/connections/ldap/%s/search", conn.ID)) }
									class="p-2 text-gray-400 hover:text-white hover:bg-dark-600 rounded-lg"
									title="Search">
									<i class="fas fa-search"></i>
								</a>
								<button onclick={ testLDAPConnection(conn.ID) }
									class="p-2 text-gray-400 hover:text-white hover:bg-dark-600 rounded-lg"
									title="Test Connection">
									<i class="fas fa-plug"></i>
								</button>
								<a href={ templ.SafeURL(fmt.Sprintf("/connections/ldap/%s/settings", conn.ID)) }
									class="p-2 text-gray-400 hover:text-white hover:bg-dark-600 rounded-lg"
									title="Settings">
									<i class="fas fa-cog"></i>
								</a>
								<button onclick={ deleteLDAPConnection(conn.ID, conn.Name) }
									class="p-2 text-gray-400 hover:text-red-400 hover:bg-dark-600 rounded-lg"
									title="Delete">
									<i class="fas fa-trash"></i>
								</button>
							</div>
						</div>
					</div>
				}
			</div>
		</div>

		<!-- New LDAP Connection Modal -->
		<div id="new-ldap-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
			<div class="flex min-h-screen items-center justify-center p-4">
				<div class="fixed inset-0 bg-black/60" onclick="hideNewLDAPModal()"></div>
				<div class="relative card w-full max-w-lg p-6">
					<h3 class="text-lg font-semibold text-white mb-4">
						<i class="fas fa-sitemap text-indigo-400 mr-2"></i>New LDAP Connection
					</h3>
					<form action="/connections/ldap" method="POST">
						<input type="hidden" name="csrf_token" value={ data.PageData.CSRFToken }/>

						<div class="space-y-4">
							<div>
								<label class="block text-sm font-medium text-gray-300 mb-1">Connection Name</label>
								<input type="text" name="name" required class="input w-full" placeholder="Active Directory"/>
							</div>

							<div class="grid grid-cols-3 gap-4">
								<div class="col-span-2">
									<label class="block text-sm font-medium text-gray-300 mb-1">Host</label>
									<input type="text" name="host" required class="input w-full" placeholder="ldap.example.com"/>
								</div>
								<div>
									<label class="block text-sm font-medium text-gray-300 mb-1">Port</label>
									<input type="number" name="port" required class="input w-full" value="389"/>
								</div>
							</div>

							<div>
								<label class="block text-sm font-medium text-gray-300 mb-1">Base DN</label>
								<input type="text" name="base_dn" required class="input w-full" placeholder="dc=example,dc=com"/>
							</div>

							<div>
								<label class="block text-sm font-medium text-gray-300 mb-1">Bind DN (Admin)</label>
								<input type="text" name="bind_dn" class="input w-full" placeholder="cn=admin,dc=example,dc=com"/>
							</div>

							<div>
								<label class="block text-sm font-medium text-gray-300 mb-1">Bind Password</label>
								<input type="password" name="bind_password" class="input w-full"/>
							</div>

							<div class="flex items-center gap-6">
								<label class="flex items-center gap-2 cursor-pointer">
									<input type="checkbox" name="use_tls" class="rounded border-dark-600 bg-dark-700 text-primary-500"/>
									<span class="text-sm text-gray-300">Use LDAPS (SSL)</span>
								</label>
								<label class="flex items-center gap-2 cursor-pointer">
									<input type="checkbox" name="start_tls" class="rounded border-dark-600 bg-dark-700 text-primary-500"/>
									<span class="text-sm text-gray-300">Use StartTLS</span>
								</label>
							</div>
						</div>

						<div class="flex justify-end gap-3 mt-6">
							<button type="button" onclick="hideNewLDAPModal()" class="btn-ghost">Cancel</button>
							<button type="submit" class="btn-primary">
								<i class="fas fa-plus mr-2"></i>Create Connection
							</button>
						</div>
					</form>
				</div>
			</div>
		</div>

		<script>
		function showNewLDAPModal() {
			document.getElementById('new-ldap-modal').classList.remove('hidden');
		}
		function hideNewLDAPModal() {
			document.getElementById('new-ldap-modal').classList.add('hidden');
		}
		function testLDAP(id) {
			fetch(`/connections/ldap/${id}/test`, {
				method: 'POST',
				headers: { 'X-CSRF-Token': document.querySelector('meta[name=csrf-token]')?.content || '' }
			})
				.then(r => r.json())
				.then(data => {
					if (data.success) {
						alert('Connection successful!');
					} else {
						alert('Connection failed: ' + data.error);
					}
				})
				.catch(err => { console.error('Connection test failed:', err); });
		}
		</script>
	}
}

// LDAPBrowser renders the LDAP directory browser with read-only default.
templ LDAPBrowser(data LDAPBrowserData) {
	@layouts.Base(data.PageData) {
		<div class="flex h-[calc(100vh-180px)]" x-data="ldapBrowser()" data-write-enabled={ ldapBoolToString(data.WriteEnabled) } data-conn-id={ data.Connection.ID }>
			<!-- Sidebar: Tree view -->
			<div class="w-80 bg-dark-800 border-r border-dark-600 flex flex-col">
				<div class="p-4 border-b border-dark-600">
					<div class="flex items-center gap-3 mb-3">
						<a href="/connections/ldap" class="text-gray-400 hover:text-white">
							<i class="fas fa-arrow-left"></i>
						</a>
						<h2 class="text-white font-medium truncate">{ data.Connection.Name }</h2>
					</div>
					<!-- Search -->
					<div class="relative">
						<input type="text" placeholder="Search entries..."
							class="input w-full text-sm pl-8"
							x-model="searchQuery"
							@keyup.enter="doSearch()"/>
						<i class="fas fa-search absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-500 text-xs"></i>
					</div>
				</div>

				<!-- Tree -->
				<div class="flex-1 overflow-y-auto py-2">
					<!-- Base DN -->
					<div class="px-2">
						<div class="flex items-center gap-1 px-2 py-1.5 text-gray-300 hover:bg-dark-700 rounded cursor-pointer"
							@click="loadEntries('')">
							<i class="fas fa-sitemap text-indigo-400 text-xs w-4"></i>
							<span class="text-sm truncate">{ data.BaseDN }</span>
						</div>
					</div>

					<!-- Entries -->
					for _, entry := range data.Entries {
						<div class="px-2">
							<div class={ "flex items-center gap-1 px-2 py-1.5 hover:bg-dark-700 rounded cursor-pointer", entryClass(entry.DN, data.CurrentDN) }
								@click={ fmt.Sprintf("selectEntry('%s')", entry.DN) }>
								if entry.HasChildren {
									<i class="fas fa-caret-right text-gray-500 text-xs w-4"></i>
								} else {
									<span class="w-4"></span>
								}
								<i class={ getObjectClassIcon(entry.ObjectClass), "text-xs w-4" }></i>
								<span class="text-sm truncate">{ getRDN(entry.DN) }</span>
							</div>
						</div>
					}
				</div>
			</div>

			<!-- Main content: Entry details -->
			<div class="flex-1 flex flex-col overflow-hidden">
				<!-- Toolbar -->
				<div class="flex items-center justify-between px-4 py-2 bg-dark-850 border-b border-dark-600">
					<div class="flex items-center gap-4">
						if data.CurrentEntry != nil {
							<h3 class="text-white font-medium truncate max-w-md">{ getRDN(data.CurrentEntry.DN) }</h3>
						} else {
							<span class="text-gray-400">Select an entry to view details</span>
						}
					</div>
					<div class="flex items-center gap-2">
						<!-- Read-only indicator -->
						if !data.WriteEnabled {
							<span class="flex items-center gap-1.5 px-2 py-1 bg-blue-500/10 text-blue-400 text-xs rounded">
								<i class="fas fa-lock"></i>
								Read-Only
							</span>
						} else {
							<span class="flex items-center gap-1.5 px-2 py-1 bg-red-500/10 text-red-400 text-xs rounded">
								<i class="fas fa-exclamation-triangle"></i>
								Write Enabled
							</span>
						}
						<a href={ templ.SafeURL(fmt.Sprintf("/connections/ldap/%s/search", data.Connection.ID)) }
							class="btn-ghost text-sm">
							<i class="fas fa-search mr-1"></i>Advanced Search
						</a>
						<button @click="showSettingsModal = true" class="btn-ghost text-sm">
							<i class="fas fa-cog mr-1"></i>Settings
						</button>
					</div>
				</div>

				<!-- Entry Details -->
				if data.CurrentEntry != nil {
					<div class="flex-1 overflow-auto p-4">
						<!-- DN -->
						<div class="mb-4">
							<label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Distinguished Name</label>
							<code class="block text-sm text-gray-300 bg-dark-700 px-3 py-2 rounded font-mono">{ data.CurrentEntry.DN }</code>
						</div>

						<!-- Object Classes -->
						<div class="mb-4">
							<label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Object Classes</label>
							<div class="flex flex-wrap gap-2">
								for _, oc := range data.CurrentEntry.ObjectClass {
									<span class="px-2 py-1 bg-indigo-500/10 text-indigo-400 text-xs rounded">{ oc }</span>
								}
							</div>
						</div>

						<!-- Attributes -->
						<div>
							<label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-2">Attributes</label>
							<div class="card divide-y divide-dark-600">
								for _, attr := range data.Attributes {
									<div class="px-4 py-3 flex items-start gap-4">
										<div class="w-48 flex-shrink-0">
											<span class="text-gray-400 text-sm font-medium">{ attr.Name }</span>
											if attr.Binary {
												<span class="ml-1 text-xs text-gray-400">(binary)</span>
											}
										</div>
										<div class="flex-1 min-w-0">
											if len(attr.Values) == 1 {
												if attr.Binary {
													<span class="text-gray-500 text-sm italic">[Binary data - { fmt.Sprintf("%d bytes", len(attr.Values[0])) }]</span>
												} else {
													<span class="text-white text-sm break-all">{ attr.Values[0] }</span>
												}
											} else {
												<ul class="space-y-1">
													for _, v := range attr.Values {
														<li class="text-white text-sm break-all">{ v }</li>
													}
												</ul>
											}
										</div>
										if data.WriteEnabled {
											<button class="text-gray-500 hover:text-white p-1" title="Edit">
												<i class="fas fa-edit text-xs"></i>
											</button>
										}
									</div>
								}
							</div>
						</div>

						<!-- Actions (only when write enabled) -->
						if data.WriteEnabled {
							<div class="mt-4 flex items-center gap-2">
								<button @click="showAddAttributeModal = true" class="btn-ghost text-sm">
									<i class="fas fa-plus mr-1"></i>Add Attribute
								</button>
								<button @click="confirmDelete()" class="btn-ghost text-sm text-red-400 hover:text-red-300">
									<i class="fas fa-trash mr-1"></i>Delete Entry
								</button>
							</div>
						}
					</div>
				} else {
					<div class="flex-1 flex items-center justify-center">
						<div class="text-center">
							<i class="fas fa-sitemap text-4xl text-gray-400 mb-4"></i>
							<p class="text-gray-400">Select an entry from the tree to view details</p>
						</div>
					</div>
				}
			</div>

			<!-- Settings Modal (Danger Zone) -->
			<div x-show="showSettingsModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto">
				<div class="flex min-h-screen items-center justify-center p-4">
					<div class="fixed inset-0 bg-black/60" @click="showSettingsModal = false"></div>
					<div class="relative card w-full max-w-md p-6">
						<h3 class="text-lg font-semibold text-white mb-4">
							<i class="fas fa-cog text-gray-400 mr-2"></i>Browser Settings
						</h3>

						<!-- Danger Zone -->
						<div class="border border-red-500/30 rounded-lg p-4 bg-red-500/5 mb-4">
							<h4 class="text-red-400 font-medium flex items-center gap-2 mb-2">
								<i class="fas fa-exclamation-triangle"></i>
								Danger Zone
							</h4>
							<p class="text-gray-400 text-sm mb-3">
								Enabling write mode allows you to modify LDAP entries and attributes.
								Incorrect changes can cause <strong class="text-red-400">authentication failures</strong>,
								<strong class="text-red-400">access control issues</strong>, or
								<strong class="text-red-400">directory corruption</strong>.
							</p>

							<div class="flex items-center justify-between p-3 bg-dark-800 rounded-lg">
								<div>
									<p class="text-white text-sm font-medium">Enable Write Mode</p>
									<p class="text-gray-500 text-xs">Allow ADD, MODIFY, DELETE operations</p>
								</div>
								<label class="relative inline-flex items-center cursor-pointer">
									<input type="checkbox" x-model="writeEnabled" class="sr-only peer"
										@change="toggleWriteMode()"/>
									<div class="w-11 h-6 bg-dark-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-500"></div>
								</label>
							</div>

							<div x-show="writeEnabled" class="mt-3 p-3 bg-red-500/10 border border-red-500/20 rounded-lg">
								<p class="text-red-400 text-xs flex items-center gap-2">
									<i class="fas fa-shield-alt"></i>
									Write mode is now enabled. Changes affect production directory!
								</p>
							</div>
						</div>

						<!-- Other settings -->
						<div class="space-y-3">
							<div class="flex items-center justify-between">
								<span class="text-gray-300 text-sm">Page size (entries)</span>
								<select x-model="pageSize" class="input text-sm w-24">
									<option value="50">50</option>
									<option value="100">100</option>
									<option value="250">250</option>
									<option value="500">500</option>
								</select>
							</div>
							<div class="flex items-center justify-between">
								<span class="text-gray-300 text-sm">Show operational attributes</span>
								<label class="relative inline-flex items-center cursor-pointer">
									<input type="checkbox" x-model="showOperational" class="sr-only peer"/>
									<div class="w-9 h-5 bg-dark-600 rounded-full peer peer-checked:bg-primary-500 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all"></div>
								</label>
							</div>
						</div>

						<div class="flex justify-end mt-6">
							<button @click="showSettingsModal = false" class="btn-primary">Done</button>
						</div>
					</div>
				</div>
			</div>
		</div>

		<script>
		function ldapBrowser() {
			return {
				showSettingsModal: false,
				showAddAttributeModal: false,
				writeEnabled: false,
				pageSize: 100,
				showOperational: false,
				searchQuery: '',
				connID: '',

				init() {
					this.writeEnabled = this.$el.dataset.writeEnabled === 'true';
					this.connID = this.$el.dataset.connId || '';
				},

				toggleWriteMode() {
					fetch(`/connections/ldap/${this.connID}/write-mode`, {
						method: 'POST',
					headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': document.querySelector('meta[name=csrf-token]')?.content || '' },
						body: JSON.stringify({ enabled: this.writeEnabled })
					}).then(() => {
						location.reload();
					});
				},

				loadEntries(dn) {
					window.location.href = `/connections/ldap/${this.connID}?dn=${encodeURIComponent(dn)}`;
				},

				selectEntry(dn) {
					window.location.href = `/connections/ldap/${this.connID}?entry=${encodeURIComponent(dn)}`;
				},

				doSearch() {
					if (!this.searchQuery.trim()) return;
					window.location.href = `/connections/ldap/${this.connID}/search?q=${encodeURIComponent(this.searchQuery)}`;
				},

				confirmDelete() {
					if (confirm('Delete this entry? This action cannot be undone and may affect authentication and access control.')) {
						// Delete logic
					}
				}
			};
		}
		</script>
	}
}

// Helper functions
func entryClass(dn, currentDN string) string {
	if dn == currentDN {
		return "bg-dark-700 text-white"
	}
	return "text-gray-400"
}

func getObjectClassIcon(objectClasses []string) string {
	for _, oc := range objectClasses {
		switch oc {
		case "organizationalUnit", "ou":
			return "fas fa-folder text-yellow-400"
		case "person", "user", "inetOrgPerson", "organizationalPerson":
			return "fas fa-user text-blue-400"
		case "group", "groupOfNames", "groupOfUniqueNames", "posixGroup":
			return "fas fa-users text-green-400"
		case "computer":
			return "fas fa-desktop text-purple-400"
		case "domain", "domainDNS":
			return "fas fa-globe text-indigo-400"
		case "organization":
			return "fas fa-building text-orange-400"
		}
	}
	return "fas fa-circle text-gray-400"
}

func getRDN(dn string) string {
	// Extract the first component (RDN) from the DN
	// e.g., "cn=John Doe,ou=Users,dc=example,dc=com" -> "cn=John Doe"
	if dn == "" {
		return ""
	}
	// Simple split by first comma
	for i, c := range dn {
		if c == ',' {
			return dn[:i]
		}
	}
	return dn
}

func ldapBoolToString(b bool) string {
	if b {
		return "true"
	}
	return "false"
}

script testLDAPConnection(id string) {
	fetch(`/connections/ldap/${id}/test`, {
		method: 'POST',
		headers: { 'X-CSRF-Token': document.querySelector('meta[name=csrf-token]')?.content || '' }
	})
		.then(r => r.json())
		.then(data => {
			if (data.success) {
				alert('Connection successful!');
			} else {
				alert('Connection failed: ' + data.error);
			}
		})
		.catch(err => { console.error('Connection test failed:', err); });
}

script deleteLDAPConnection(id string, name string) {
	if (confirm(`Delete LDAP connection "${name}"? This cannot be undone.`)) {
		const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';
		fetch(`/connections/ldap/${id}`, {
			method: 'DELETE',
			headers: { 'X-CSRF-Token': csrfToken }
		})
		.then(r => { if (r.ok) location.reload(); else alert('Failed to delete connection'); })
		.catch(e => alert('Error: ' + e));
	}
}

// LDAPConnectionSettingsData is the data for the LDAP connection settings page.
type LDAPConnectionSettingsData struct {
	PageData   layouts.PageData
	Connection LDAPConnectionData
}

// LDAPConnectionSettings renders the LDAP connection settings/edit page.
templ LDAPConnectionSettings(data LDAPConnectionSettingsData) {
	@layouts.Base(data.PageData) {
		<div class="max-w-2xl mx-auto space-y-6">
			<!-- Header -->
			<div class="flex items-center gap-4">
				<a href="/connections/ldap" class="p-2 text-gray-400 hover:text-white hover:bg-dark-700 rounded-lg">
					<i class="fas fa-arrow-left"></i>
				</a>
				<div class="flex-1">
					<div class="flex items-center gap-3">
						<h1 class="text-2xl font-display font-bold text-white">{ data.Connection.Name }</h1>
						if data.Connection.Status == "connected" {
							<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-500/10 text-green-400">
								Connected
							</span>
						} else {
							<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-500/10 text-gray-400">
								Offline
							</span>
						}
					</div>
					<p class="text-gray-400 mt-1">{ data.Connection.Host }:{ fmt.Sprintf("%d", data.Connection.Port) }</p>
				</div>
			</div>

			<!-- Quick Actions -->
			<div class="grid grid-cols-3 gap-4">
				<a href={ templ.SafeURL(fmt.Sprintf("/connections/ldap/%s", data.Connection.ID)) }
					class="card p-4 flex items-center gap-3 hover:bg-dark-700/50 transition-colors">
					<div class="w-10 h-10 bg-indigo-500/10 rounded-lg flex items-center justify-center">
						<i class="fas fa-folder-tree text-indigo-400"></i>
					</div>
					<div>
						<p class="text-white font-medium">Browse</p>
						<p class="text-xs text-gray-400">Directory tree</p>
					</div>
				</a>
				<a href={ templ.SafeURL(fmt.Sprintf("/connections/ldap/%s/search", data.Connection.ID)) }
					class="card p-4 flex items-center gap-3 hover:bg-dark-700/50 transition-colors">
					<div class="w-10 h-10 bg-blue-500/10 rounded-lg flex items-center justify-center">
						<i class="fas fa-search text-blue-400"></i>
					</div>
					<div>
						<p class="text-white font-medium">Search</p>
						<p class="text-xs text-gray-400">Advanced search</p>
					</div>
				</a>
				<button
					class="card p-4 flex items-center gap-3 hover:bg-dark-700/50 transition-colors text-left"
					onclick={ testLDAPConnection(data.Connection.ID) }
				>
					<div class="w-10 h-10 bg-green-500/10 rounded-lg flex items-center justify-center">
						<i class="fas fa-plug text-green-400"></i>
					</div>
					<div>
						<p class="text-white font-medium">Test</p>
						<p class="text-xs text-gray-400">Verify connection</p>
					</div>
				</button>
			</div>

			<!-- Edit Form -->
			<form method="POST" action={ templ.SafeURL(fmt.Sprintf("/connections/ldap/%s/settings", data.Connection.ID)) } class="space-y-6">
				<input type="hidden" name="csrf_token" value={ data.PageData.CSRFToken }/>

				<div class="card p-6 space-y-4">
					<h2 class="text-lg font-medium text-white">Connection Details</h2>

					<div>
						<label for="name" class="block text-sm font-medium text-gray-300 mb-1">Connection Name</label>
						<input type="text" id="name" name="name" required class="input w-full" value={ data.Connection.Name }/>
					</div>

					<div class="grid grid-cols-3 gap-4">
						<div class="col-span-2">
							<label for="host" class="block text-sm font-medium text-gray-300 mb-1">Host</label>
							<input type="text" id="host" name="host" required class="input w-full" value={ data.Connection.Host }/>
						</div>
						<div>
							<label for="port" class="block text-sm font-medium text-gray-300 mb-1">Port</label>
							<input type="number" id="port" name="port" required class="input w-full" value={ fmt.Sprintf("%d", data.Connection.Port) }/>
						</div>
					</div>

					<div>
						<label for="base_dn" class="block text-sm font-medium text-gray-300 mb-1">Base DN</label>
						<input type="text" id="base_dn" name="base_dn" required class="input w-full" value={ data.Connection.BaseDN }/>
					</div>

					<div>
						<label for="bind_dn" class="block text-sm font-medium text-gray-300 mb-1">Bind DN (Admin)</label>
						<input type="text" id="bind_dn" name="bind_dn" class="input w-full" value={ data.Connection.BindDN }/>
					</div>

					<div>
						<label for="bind_password" class="block text-sm font-medium text-gray-300 mb-1">Bind Password</label>
						<input type="password" id="bind_password" name="bind_password" class="input w-full" placeholder="Leave blank to keep current"/>
					</div>

					<div class="flex items-center gap-6">
						<label class="flex items-center gap-2 cursor-pointer">
							if data.Connection.UseSSL {
								<input type="checkbox" name="use_tls" checked class="rounded border-dark-600 bg-dark-700 text-primary-500"/>
							} else {
								<input type="checkbox" name="use_tls" class="rounded border-dark-600 bg-dark-700 text-primary-500"/>
							}
							<span class="text-sm text-gray-300">Use LDAPS (SSL)</span>
						</label>
						<label class="flex items-center gap-2 cursor-pointer">
							if data.Connection.UseTLS {
								<input type="checkbox" name="start_tls" checked class="rounded border-dark-600 bg-dark-700 text-primary-500"/>
							} else {
								<input type="checkbox" name="start_tls" class="rounded border-dark-600 bg-dark-700 text-primary-500"/>
							}
							<span class="text-sm text-gray-300">Use StartTLS</span>
						</label>
						<label class="flex items-center gap-2 cursor-pointer">
							<input type="checkbox" name="skip_tls_verify" class="rounded border-dark-600 bg-dark-700 text-primary-500"/>
							<span class="text-sm text-gray-300">Skip TLS verify</span>
						</label>
					</div>
				</div>

				<!-- Submit -->
				<div class="flex justify-end gap-3">
					<a href="/connections/ldap" class="btn-secondary">Cancel</a>
					<button type="submit" class="btn-primary">
						<i class="fas fa-save mr-2"></i>Save Changes
					</button>
				</div>
			</form>

			<!-- Connection Info -->
			<div class="card p-6">
				<h2 class="text-lg font-medium text-white mb-4">Connection Info</h2>
				<dl class="grid grid-cols-2 gap-4 text-sm">
					if data.Connection.LastChecked != "" {
						<div>
							<dt class="text-gray-500">Last Checked</dt>
							<dd class="text-gray-300">{ data.Connection.LastChecked }</dd>
						</div>
					}
					<div>
						<dt class="text-gray-500">Connection ID</dt>
						<dd class="text-gray-300 font-mono text-xs">{ data.Connection.ID }</dd>
					</div>
				</dl>
			</div>

			<!-- Danger Zone -->
			<div class="card border-red-500/30 p-6">
				<h2 class="text-lg font-medium text-red-400 mb-4">
					<i class="fas fa-exclamation-triangle mr-2"></i>Danger Zone
				</h2>
				<div class="flex items-center justify-between p-4 bg-red-500/5 border border-red-500/20 rounded-lg">
					<div>
						<p class="text-white font-medium">Delete this connection</p>
						<p class="text-gray-400 text-sm">Permanently remove this LDAP connection and all its settings.</p>
					</div>
					<button onclick={ deleteLDAPConnection(data.Connection.ID, data.Connection.Name) }
						class="px-4 py-2 bg-red-500/10 text-red-400 hover:bg-red-500/20 rounded-lg transition-colors text-sm font-medium">
						<i class="fas fa-trash mr-2"></i>Delete
					</button>
				</div>
			</div>
		</div>
	}
}
